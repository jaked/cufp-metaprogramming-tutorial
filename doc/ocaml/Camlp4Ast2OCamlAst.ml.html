<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.37 in css mode. -->
<html>
  <head>
    <title>Camlp4Ast2OCamlAst.ml</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <pre>
<span class="comment">(* camlp4r *)</span>
<span class="comment">(****************************************************************************)</span>
<span class="comment">(*                                                                          *)</span>
<span class="comment">(*                              Objective Caml                              *)</span>
<span class="comment">(*                                                                          *)</span>
<span class="comment">(*                            INRIA Rocquencourt                            *)</span>
<span class="comment">(*                                                                          *)</span>
<span class="comment">(*  Copyright 2002-2006 Institut National de Recherche en Informatique et   *)</span>
<span class="comment">(*  en Automatique.  All rights reserved.  This file is distributed under   *)</span>
<span class="comment">(*  the terms of the GNU Library General Public License, with the special   *)</span>
<span class="comment">(*  exception on linking described in LICENSE at the top of the Objective   *)</span>
<span class="comment">(*  Caml source tree.                                                       *)</span>
<span class="comment">(*                                                                          *)</span>
<span class="comment">(****************************************************************************)</span>

<span class="comment">(* Authors:
 * - Daniel de Rauglaudre: initial version
 * - Nicolas Pouillard: refactoring
 *)</span>



<span class="tuareg-font-lock-governing">module</span> <span class="type">Make </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">Ast</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">Sig.Camlp4Ast</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-governing">struct</span>
  <span class="tuareg-font-lock-governing">open</span> <span class="type">Format</span><span class="tuareg-font-lock-operator">;</span>
  <span class="tuareg-font-lock-governing">open</span> <span class="type">Camlp4_import.Parsetree</span><span class="tuareg-font-lock-operator">;</span>
  <span class="tuareg-font-lock-governing">open</span> <span class="type">Camlp4_import.Longident</span><span class="tuareg-font-lock-operator">;</span>
  <span class="tuareg-font-lock-governing">open</span> <span class="type">Camlp4_import.Asttypes</span><span class="tuareg-font-lock-operator">;</span>
  <span class="tuareg-font-lock-governing">open</span> <span class="type">Ast</span><span class="tuareg-font-lock-operator">;</span>

  value constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-operator">=</span>
    debug ast2pt <span class="string">"constructors_arity: %b@."</span> <span class="type">Camlp4_config</span>.constructors_arity.<span class="tuareg-font-lock-governing">val</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="type">Camlp4_config</span>.constructors_arity.<span class="tuareg-font-lock-governing">val</span><span class="tuareg-font-lock-operator">;</span>

  value error loc str <span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.<span class="keyword">raise</span> loc <span class="tuareg-font-lock-operator">(</span>Failure str<span class="tuareg-font-lock-operator">);</span>

  value char_of_char_token loc s <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">try</span> <span class="type">Token</span>.<span class="type">Eval</span>.char s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span> Failure _ <span class="keyword">as</span> exn <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Loc</span>.<span class="keyword">raise</span> loc exn <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value string_of_string_token loc s <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">try</span> <span class="type">Token</span>.<span class="type">Eval</span>.string s
    <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span> Failure _ <span class="keyword">as</span> exn <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Loc</span>.<span class="keyword">raise</span> loc exn <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value remove_underscores s <span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">l </span><span class="tuareg-font-lock-operator">=</span> <span class="type">String</span>.length s <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">remove</span><span class="variable-name"> src dst </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">if</span> src <span class="tuareg-font-lock-operator">&gt;=</span> l <span class="keyword">then</span>
        <span class="keyword">if</span> dst <span class="tuareg-font-lock-operator">&gt;=</span> l <span class="keyword">then</span> s <span class="keyword">else</span> <span class="type">String</span>.sub s 0 dst
      <span class="keyword">else</span>
        <span class="keyword">match</span> s.<span class="tuareg-font-lock-operator">[</span>src<span class="tuareg-font-lock-operator">]</span> <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="string">'_'</span> <span class="tuareg-font-lock-operator">-&gt;</span> remove <span class="tuareg-font-lock-operator">(</span>src <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">)</span> dst
        <span class="tuareg-font-lock-operator">|</span>  c  <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">do</span> <span class="tuareg-font-lock-operator">{</span> s.<span class="tuareg-font-lock-operator">[</span>dst<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">:=</span> c<span class="tuareg-font-lock-operator">;</span> remove <span class="tuareg-font-lock-operator">(</span>src <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>dst <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-governing">in</span> remove 0 0
  <span class="tuareg-font-lock-operator">;</span>

  value mkloc <span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.to_ocaml_location<span class="tuareg-font-lock-operator">;</span>
  value mkghloc loc <span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.to_ocaml_location <span class="tuareg-font-lock-operator">(</span><span class="type">Loc</span>.ghostify loc<span class="tuareg-font-lock-operator">);</span>

  value mktyp loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>ptyp_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> ptyp_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkpat loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>ppat_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> ppat_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkghpat loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>ppat_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> ppat_loc <span class="tuareg-font-lock-operator">=</span> mkghloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkexp loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pexp_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pexp_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkmty loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pmty_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pmty_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mksig loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>psig_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> psig_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkmod loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pmod_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pmod_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkstr loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pstr_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pstr_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkfield loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pfield_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pfield_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkcty loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pcty_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pcty_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkpcl loc d <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pcl_desc <span class="tuareg-font-lock-operator">=</span> d<span class="tuareg-font-lock-operator">;</span> pcl_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">};</span>
  value mkpolytype t <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t.ptyp_desc <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> Ptyp_poly _ _ <span class="tuareg-font-lock-operator">-&gt;</span> t
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">{</span> <span class="tuareg-font-lock-operator">(</span>t<span class="tuareg-font-lock-operator">)</span> <span class="keyword">with</span> ptyp_desc <span class="tuareg-font-lock-operator">=</span> Ptyp_poly <span class="tuareg-font-lock-operator">[]</span> t <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value mkvirtual <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">virtual_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">virtual</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Virtual
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">virtual_flag</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Concrete
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value mkdirection <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">direction_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">to</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Upto
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">direction_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">downto</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Downto
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value lident s <span class="tuareg-font-lock-operator">=</span> Lident s<span class="tuareg-font-lock-operator">;</span>
  value ldot l s <span class="tuareg-font-lock-operator">=</span> Ldot l s<span class="tuareg-font-lock-operator">;</span>
  value lapply l s <span class="tuareg-font-lock-operator">=</span> Lapply l s<span class="tuareg-font-lock-operator">;</span>

  value conv_con <span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Hashtbl</span>.create 73 <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">do</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="type">List</span>.iter <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">s</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> s</span><span class="tuareg-font-lock-operator">')</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Hashtbl</span>.add t s s<span class="tuareg-font-lock-operator">')</span>
        <span class="tuareg-font-lock-operator">[(</span><span class="string">"True"</span><span class="tuareg-font-lock-operator">,</span> <span class="string">"true"</span><span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">"False"</span><span class="tuareg-font-lock-operator">,</span> <span class="string">"false"</span><span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">" True"</span><span class="tuareg-font-lock-operator">,</span> <span class="string">"True"</span><span class="tuareg-font-lock-operator">);</span>
        <span class="tuareg-font-lock-operator">(</span><span class="string">" False"</span><span class="tuareg-font-lock-operator">,</span> <span class="string">"False"</span><span class="tuareg-font-lock-operator">)];</span>
      <span class="keyword">fun</span> <span class="variable-name">s </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">try</span> <span class="type">Hashtbl</span>.find t s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span> s <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">}</span>
  <span class="tuareg-font-lock-operator">;</span>

  value conv_lab <span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Hashtbl</span>.create 73 <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">do</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="type">List</span>.iter <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">s</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> s</span><span class="tuareg-font-lock-operator">')</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Hashtbl</span>.add t s s<span class="tuareg-font-lock-operator">')</span> <span class="tuareg-font-lock-operator">[(</span><span class="string">"val"</span><span class="tuareg-font-lock-operator">,</span> <span class="string">"contents"</span><span class="tuareg-font-lock-operator">)];</span>
      <span class="keyword">fun</span> <span class="variable-name">s </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">try</span> <span class="type">Hashtbl</span>.find t s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span> s <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">}</span>
  <span class="tuareg-font-lock-operator">;</span>

  value array_function str name <span class="tuareg-font-lock-operator">=</span>
    ldot <span class="tuareg-font-lock-operator">(</span>lident str<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span><span class="keyword">if</span> <span class="type">Camlp4_config</span>.unsafe.<span class="tuareg-font-lock-governing">val</span> <span class="keyword">then</span><span class="variable-name"> </span><span class="string">"unsafe_"</span> <span class="tuareg-font-lock-operator">^</span> name <span class="keyword">else</span> name<span class="tuareg-font-lock-operator">)</span>
  <span class="tuareg-font-lock-operator">;</span>

  value mkrf <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">rec</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Recursive
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_flag</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Nonrecursive
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value mkli s <span class="tuareg-font-lock-operator">=</span> loop lident
    where <span class="tuareg-font-lock-governing">rec</span> loop f <span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">fun</span>
     <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[</span>i <span class="tuareg-font-lock-operator">::</span> il<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> loop <span class="tuareg-font-lock-operator">(</span>ldot <span class="tuareg-font-lock-operator">(</span>f i<span class="tuareg-font-lock-operator">))</span> il
      <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> f s <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> ctyp_fa al <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> TyApp _ f a <span class="tuareg-font-lock-operator">-&gt;</span> ctyp_fa <span class="tuareg-font-lock-operator">[</span>a <span class="tuareg-font-lock-operator">::</span> al<span class="tuareg-font-lock-operator">]</span> f
    <span class="tuareg-font-lock-operator">|</span> f <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>f<span class="tuareg-font-lock-operator">,</span> al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value ident_tag <span class="tuareg-font-lock-operator">?(</span>conv_lid <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">-&gt;</span> x<span class="tuareg-font-lock-operator">)</span> i <span class="tuareg-font-lock-operator">=</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">self</span><span class="variable-name"> i acc </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">match</span> i <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i1<span class="tuareg-font-lock-operator">$.$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
          self i2 <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>self i1 acc<span class="tuareg-font-lock-operator">))</span>
      <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> Lapply <span class="tuareg-font-lock-operator">(</span>fst <span class="tuareg-font-lock-operator">(</span>self i1 None<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">(</span>fst <span class="tuareg-font-lock-operator">(</span>self i2 None<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">match</span> acc <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">[</span> None <span class="tuareg-font-lock-operator">-&gt;</span> i<span class="tuareg-font-lock-operator">'</span>
            <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid long identifier"</span> <span class="tuareg-font-lock-operator">]</span>
          <span class="tuareg-font-lock-governing">in</span> <span class="tuareg-font-lock-operator">(</span>x<span class="tuareg-font-lock-operator">,</span> `app<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">match</span> acc <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">[</span> None <span class="tuareg-font-lock-operator">-&gt;</span> lident s
            <span class="tuareg-font-lock-operator">|</span> Some <span class="tuareg-font-lock-operator">(</span>acc<span class="tuareg-font-lock-operator">,</span> `uident <span class="tuareg-font-lock-operator">|</span> `app<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> ldot acc s
            <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid long identifier"</span> <span class="tuareg-font-lock-operator">]</span>
          <span class="tuareg-font-lock-governing">in</span> <span class="tuareg-font-lock-operator">(</span>x<span class="tuareg-font-lock-operator">,</span> `uident<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">match</span> acc <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">[</span> None <span class="tuareg-font-lock-operator">-&gt;</span> lident <span class="tuareg-font-lock-operator">(</span>conv_lid s<span class="tuareg-font-lock-operator">)</span>
            <span class="tuareg-font-lock-operator">|</span> Some <span class="tuareg-font-lock-operator">(</span>acc<span class="tuareg-font-lock-operator">,</span> `uident <span class="tuareg-font-lock-operator">|</span> `app<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> ldot acc <span class="tuareg-font-lock-operator">(</span>conv_lid s<span class="tuareg-font-lock-operator">)</span>
            <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid long identifier"</span> <span class="tuareg-font-lock-operator">]</span>
          <span class="tuareg-font-lock-governing">in</span> <span class="tuareg-font-lock-operator">(</span>x<span class="tuareg-font-lock-operator">,</span> `lident<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid long identifier"</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-governing">in</span> self i None<span class="tuareg-font-lock-operator">;</span>

  value ident <span class="tuareg-font-lock-operator">?</span>conv_lid i <span class="tuareg-font-lock-operator">=</span> fst <span class="tuareg-font-lock-operator">(</span>ident_tag <span class="tuareg-font-lock-operator">?</span>conv_lid i<span class="tuareg-font-lock-operator">);</span>

  value long_lident msg i <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> ident_tag i <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span>i<span class="tuareg-font-lock-operator">,</span> `lident<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> i
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> msg <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value long_type_ident <span class="tuareg-font-lock-operator">=</span> long_lident <span class="string">"invalid long identifier type"</span><span class="tuareg-font-lock-operator">;</span>
  value long_class_ident <span class="tuareg-font-lock-operator">=</span> long_lident <span class="string">"invalid class name"</span><span class="tuareg-font-lock-operator">;</span>

  value long_uident <span class="tuareg-font-lock-operator">?(</span>conv_con <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">-&gt;</span> x<span class="tuareg-font-lock-operator">)</span> i <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> ident_tag i <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span>Ldot i s<span class="tuareg-font-lock-operator">,</span> `uident<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> ldot i <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(</span>Lident s<span class="tuareg-font-lock-operator">,</span> `uident<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> lident <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(</span>i<span class="tuareg-font-lock-operator">,</span> `app<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> i
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ident i<span class="tuareg-font-lock-operator">)</span> <span class="string">"uppercase identifier expected"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> ctyp_long_id_prefix t <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> ident i</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>m1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>m2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">li1 </span><span class="tuareg-font-lock-operator">=</span> ctyp_long_id_prefix m1 <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">li2 </span><span class="tuareg-font-lock-operator">=</span> ctyp_long_id_prefix m2 <span class="tuareg-font-lock-governing">in</span>
        Lapply li1 li2
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid module expression"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value ctyp_long_id t <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">(</span>False<span class="tuareg-font-lock-operator">,</span> long_type_ident i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> TyApp loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"invalid type name"</span>
    <span class="tuareg-font-lock-operator">|</span> TyCls _ i <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>True<span class="tuareg-font-lock-operator">,</span> ident i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid type"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> ty_var_list_of_ctyp <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> ty_var_list_of_ctyp t1 <span class="tuareg-font-lock-operator">@</span> ty_var_list_of_ctyp t2
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>s<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> ctyp <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> TyId loc i <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">li </span><span class="tuareg-font-lock-operator">=</span> long_type_ident i <span class="tuareg-font-lock-governing">in</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_constr li <span class="tuareg-font-lock-operator">[])</span>
    <span class="tuareg-font-lock-operator">|</span> TyAli loc t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">t</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> i</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>t1<span class="tuareg-font-lock-operator">,</span> t2<span class="tuareg-font-lock-operator">)</span> <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span>t<span class="tuareg-font-lock-operator">,</span> TyQuo _ s<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>t<span class="tuareg-font-lock-operator">,</span> s<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(</span>TyQuo _ s<span class="tuareg-font-lock-operator">,</span> t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>t<span class="tuareg-font-lock-operator">,</span> s<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"invalid alias type"</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_alias <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> TyAny loc <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc Ptyp_any
    <span class="tuareg-font-lock-operator">|</span> TyApp loc _ _ <span class="keyword">as</span> f <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> al</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> ctyp_fa <span class="tuareg-font-lock-operator">[]</span> f <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">is_cls</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> li</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> ctyp_long_id f <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">if</span> is_cls <span class="keyword">then</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_class li <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">[])</span>
        <span class="keyword">else</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_constr li <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp al<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> TyArr loc <span class="tuareg-font-lock-operator">(</span>TyLab _ lab t1<span class="tuareg-font-lock-operator">)</span> t2 <span class="tuareg-font-lock-operator">-&gt;</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_arrow lab <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> TyArr loc <span class="tuareg-font-lock-operator">(</span>TyOlb loc1 lab t1<span class="tuareg-font-lock-operator">)</span> t2 <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t1 </span><span class="tuareg-font-lock-operator">=</span> TyApp loc1 <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc1<span class="tuareg-font-lock-operator">&lt;</span> option <span class="tuareg-font-lock-operator">&gt;&gt;</span> t1 <span class="tuareg-font-lock-governing">in</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_arrow <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> TyArr loc t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_arrow <span class="string">""</span> <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>fl<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_object <span class="tuareg-font-lock-operator">(</span>meth_list fl <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>fl<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">..</span> <span class="tuareg-font-lock-operator">&gt;</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_object <span class="tuareg-font-lock-operator">(</span>meth_list fl <span class="tuareg-font-lock-operator">[</span>mkfield loc Pfield_var<span class="tuareg-font-lock-operator">]))</span>
    <span class="tuareg-font-lock-operator">|</span> TyCls loc id <span class="tuareg-font-lock-operator">-&gt;</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_class <span class="tuareg-font-lock-operator">(</span>ident id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">[])</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">module</span> <span class="tuareg-font-lock-operator">$</span><span class="type">pt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">i</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> cs</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> package_type pt <span class="tuareg-font-lock-governing">in</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_package i cs<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> TyLab loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labelled type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyMan loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"manifest type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyOlb loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labelled type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyPol loc t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_poly <span class="tuareg-font-lock-operator">(</span>ty_var_list_of_ctyp t1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> TyQuo loc s <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_var s<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> TyRec loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"record type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TySum loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"sum type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyPrv loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"private type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyMut loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"mutable type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyOr loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"type1 | type2 not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyAnd loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"type1 and type2 not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyOf loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"type1 of type2 not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyCol loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"type1 : type2 not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TySem loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"type1 ; type2 not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">*</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
         mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_tuple <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t1 <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t2 <span class="tuareg-font-lock-operator">[]))))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_variant <span class="tuareg-font-lock-operator">(</span>row_field t<span class="tuareg-font-lock-operator">)</span> True None<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&gt;</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_variant <span class="tuareg-font-lock-operator">(</span>row_field t<span class="tuareg-font-lock-operator">)</span> False None<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_variant <span class="tuareg-font-lock-operator">(</span>row_field t<span class="tuareg-font-lock-operator">)</span> True <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">'$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mktyp loc <span class="tuareg-font-lock-operator">(</span>Ptyp_variant <span class="tuareg-font-lock-operator">(</span>row_field t<span class="tuareg-font-lock-operator">)</span> True <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>name_tags t<span class="tuareg-font-lock-operator">')))</span>
    <span class="tuareg-font-lock-operator">|</span> TyAnt loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"antiquotation not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> TyOfAmp _ _ _ <span class="tuareg-font-lock-operator">|</span>TyAmp _ _ _ <span class="tuareg-font-lock-operator">|</span>TySta _ _ _ <span class="tuareg-font-lock-operator">|</span>
      TyCom _ _ _ <span class="tuareg-font-lock-operator">|</span>TyVrn _ _ <span class="tuareg-font-lock-operator">|</span>TyQuM _ _ <span class="tuareg-font-lock-operator">|</span>TyQuP _ _ <span class="tuareg-font-lock-operator">|</span>TyDcl _ _ _ _ _ <span class="tuareg-font-lock-operator">|</span>
      TyObj _ _ <span class="tuareg-font-lock-operator">(</span>RvAnt _<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">|</span> TyNil _ <span class="tuareg-font-lock-operator">|</span> TyTup _ _ <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">row_field</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> `<span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Rtag i True <span class="tuareg-font-lock-operator">[]]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> `<span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">&amp;</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Rtag i True <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[]))]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> `<span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Rtag i False <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[]))]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> row_field t1 <span class="tuareg-font-lock-operator">@</span> row_field t2
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Rinherit <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)]</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">name_tags</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> name_tags t1 <span class="tuareg-font-lock-operator">@</span> name_tags t2
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> `<span class="tuareg-font-lock-operator">$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>s<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">meth_list</span><span class="variable-name"> fl acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> fl <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> meth_list t1 <span class="tuareg-font-lock-operator">(</span>meth_list t2 acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">lab</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkfield loc <span class="tuareg-font-lock-operator">(</span>Pfield lab <span class="tuareg-font-lock-operator">(</span>mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>

  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">package_type_constraints</span><span class="variable-name"> wc acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> wc <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">$</span><span class="type">lid</span><span class="tuareg-font-lock-operator">:</span><span class="type">id</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>ct<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>id<span class="tuareg-font-lock-operator">,</span> ctyp ct<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>wc1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">wc2</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        package_type_constraints wc1 <span class="tuareg-font-lock-operator">(</span>package_type_constraints wc2 acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_with_constr wc<span class="tuareg-font-lock-operator">)</span> <span class="string">"unexpected `with constraint' for a package type"</span> <span class="tuareg-font-lock-operator">]</span>

  <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">package_type </span><span class="tuareg-font-lock-operator">:</span> <span class="type">module_type </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> package_type </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="keyword">with</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">wc</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
      <span class="tuareg-font-lock-operator">(</span>long_uident i<span class="tuareg-font-lock-operator">,</span> package_type_constraints wc <span class="tuareg-font-lock-operator">[])</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">(</span>long_uident i<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">[])</span>
    <span class="tuareg-font-lock-operator">|</span> mt <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_module_type mt<span class="tuareg-font-lock-operator">)</span> <span class="string">"unexpected package type"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value mktype loc tl cl tk tp tm <span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">params</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> variance</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.split tl <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-operator">{</span>ptype_params <span class="tuareg-font-lock-operator">=</span> params<span class="tuareg-font-lock-operator">;</span> ptype_cstrs <span class="tuareg-font-lock-operator">=</span> cl<span class="tuareg-font-lock-operator">;</span> ptype_kind <span class="tuareg-font-lock-operator">=</span> tk<span class="tuareg-font-lock-operator">;</span>
     ptype_private <span class="tuareg-font-lock-operator">=</span> tp<span class="tuareg-font-lock-operator">;</span> ptype_manifest <span class="tuareg-font-lock-operator">=</span> tm<span class="tuareg-font-lock-operator">;</span> ptype_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">;</span>
     ptype_variance <span class="tuareg-font-lock-operator">=</span> variance<span class="tuareg-font-lock-operator">}</span>
  <span class="tuareg-font-lock-operator">;</span>
  value mkprivate<span class="tuareg-font-lock-operator">'</span> m <span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> m <span class="keyword">then</span> Private <span class="keyword">else</span> Public<span class="tuareg-font-lock-operator">;</span>
  value mkprivate <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">private_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">private</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Private
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">private_flag</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Public
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>
  value mktrecord <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:</span> <span class="keyword">mutable</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> Mutable<span class="tuareg-font-lock-operator">,</span> mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> Immutable<span class="tuareg-font-lock-operator">,</span> mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="comment">(*FIXME*)</span> <span class="tuareg-font-lock-operator">];</span>
  value mkvariant <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">[],</span> mkloc loc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">of</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">t</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">,</span> <span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[]),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="comment">(*FIXME*)</span> <span class="tuareg-font-lock-operator">];</span>
  value <span class="tuareg-font-lock-governing">rec</span> type_decl tl cl loc m pflag <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">==</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        type_decl tl cl loc <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">))</span> pflag t2
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">private</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        type_decl tl cl loc m True t
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">{</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mktype loc tl cl
          <span class="tuareg-font-lock-operator">(</span>Ptype_record <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map mktrecord <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">(</span>mkprivate<span class="tuareg-font-lock-operator">'</span> pflag<span class="tuareg-font-lock-operator">)</span> m
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mktype loc tl cl
          <span class="tuareg-font-lock-operator">(</span>Ptype_variant <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map mkvariant <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">(</span>mkprivate<span class="tuareg-font-lock-operator">'</span> pflag<span class="tuareg-font-lock-operator">)</span> m
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">if</span> m <span class="tuareg-font-lock-operator">&lt;&gt;</span> None <span class="keyword">then</span>
          error loc <span class="string">"only one manifest type allowed by definition"</span> <span class="keyword">else</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">m </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> t <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> None
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> Some <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        mktype loc tl cl Ptype_abstract <span class="tuareg-font-lock-operator">(</span>mkprivate<span class="tuareg-font-lock-operator">'</span> pflag<span class="tuareg-font-lock-operator">)</span> m <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value type_decl tl cl t <span class="tuareg-font-lock-operator">=</span> type_decl tl cl <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t<span class="tuareg-font-lock-operator">)</span> None False t<span class="tuareg-font-lock-operator">;</span>

  value mkvalue_desc t p <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>pval_type <span class="tuareg-font-lock-operator">=</span> ctyp t<span class="tuareg-font-lock-operator">;</span> pval_prim <span class="tuareg-font-lock-operator">=</span> p<span class="tuareg-font-lock-operator">};</span>

  value <span class="tuareg-font-lock-governing">rec</span> list_of_meta_list <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="type">Ast</span>.LNil <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="type">Ast</span>.LCons x xs <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>x <span class="tuareg-font-lock-operator">::</span> list_of_meta_list xs<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="type">Ast</span>.LAnt _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value mkmutable <span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">mutable_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">mutable</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Mutable
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">mutable_flag</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Immutable
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value paolab lab p <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>lab<span class="tuareg-font-lock-operator">,</span> p<span class="tuareg-font-lock-operator">)</span> <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;)</span> <span class="tuareg-font-lock-operator">-&gt;</span> i
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_patt p<span class="tuareg-font-lock-operator">)</span> <span class="string">"bad ast in label"</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> lab <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value opt_private_ctyp <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">private</span> <span class="tuareg-font-lock-operator">$</span>t<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>Ptype_abstract<span class="tuareg-font-lock-operator">,</span> Private<span class="tuareg-font-lock-operator">,</span> ctyp t<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>Ptype_abstract<span class="tuareg-font-lock-operator">,</span> Public<span class="tuareg-font-lock-operator">,</span> ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> type_parameters t acc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> type_parameters t1 <span class="tuareg-font-lock-operator">(</span>type_parameters t2 acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">+'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>True<span class="tuareg-font-lock-operator">,</span> False<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">-'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>False<span class="tuareg-font-lock-operator">,</span> True<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>False<span class="tuareg-font-lock-operator">,</span> False<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> class_parameters t acc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$,</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> class_parameters t1 <span class="tuareg-font-lock-operator">(</span>class_parameters t2 acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">+'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>True<span class="tuareg-font-lock-operator">,</span> False<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">-'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>False<span class="tuareg-font-lock-operator">,</span> True<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">'$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>False<span class="tuareg-font-lock-operator">,</span> False<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> type_parameters_and_type_name t acc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> t <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>t1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>t2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        type_parameters_and_type_name t1
          <span class="tuareg-font-lock-operator">(</span>type_parameters t2 acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">(</span><span class="type">ident i</span><span class="tuareg-font-lock-operator">,</span><span class="type"> acc</span><span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value mkwithtyp pwith_type loc id_tpl ct <span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">id</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> tpl</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> type_parameters_and_type_name id_tpl <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">params</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> variance</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.split tpl <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">kind</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> priv</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ct</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> opt_private_ctyp ct <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-operator">(</span>id<span class="tuareg-font-lock-operator">,</span> pwith_type
      <span class="tuareg-font-lock-operator">{</span>ptype_params <span class="tuareg-font-lock-operator">=</span> params<span class="tuareg-font-lock-operator">;</span> ptype_cstrs <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">[];</span>
        ptype_kind <span class="tuareg-font-lock-operator">=</span> kind<span class="tuareg-font-lock-operator">;</span>
        ptype_private <span class="tuareg-font-lock-operator">=</span> priv<span class="tuareg-font-lock-operator">;</span>
        ptype_manifest <span class="tuareg-font-lock-operator">=</span> Some ct<span class="tuareg-font-lock-operator">;</span>
        ptype_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">;</span> ptype_variance <span class="tuareg-font-lock-operator">=</span> variance<span class="tuareg-font-lock-operator">});</span>

  value <span class="tuareg-font-lock-governing">rec</span> mkwithc wc acc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> wc <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">$</span><span class="type">id_tpl</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>ct<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkwithtyp <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">-&gt;</span> Pwith_type x<span class="tuareg-font-lock-operator">)</span> loc id_tpl ct <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">module</span> <span class="tuareg-font-lock-operator">$</span><span class="type">i1</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>long_uident i1<span class="tuareg-font-lock-operator">,</span> Pwith_module <span class="tuareg-font-lock-operator">(</span>long_uident i2<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">$</span><span class="type">id_tpl</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:=</span> <span class="tuareg-font-lock-operator">$</span>ct<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkwithtyp <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">-&gt;</span> Pwith_typesubst x<span class="tuareg-font-lock-operator">)</span> loc id_tpl ct <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">module</span> <span class="tuareg-font-lock-operator">$</span><span class="type">i1</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:=</span> <span class="tuareg-font-lock-operator">$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="comment">(*WcMoS _ i1 i2*)</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>long_uident i1<span class="tuareg-font-lock-operator">,</span> Pwith_modsubst <span class="tuareg-font-lock-operator">(</span>long_uident i2<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>wc1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">wc2</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="variable-name"> mkwithc wc1 </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">mkwithc wc2 acc</span><span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">with_constr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
         error loc <span class="string">"bad with constraint (antiquotation)"</span> <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> patt_fa al <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> PaApp _ f a <span class="tuareg-font-lock-operator">-&gt;</span> patt_fa <span class="tuareg-font-lock-operator">[</span>a <span class="tuareg-font-lock-operator">::</span> al<span class="tuareg-font-lock-operator">]</span> f
    <span class="tuareg-font-lock-operator">|</span> f <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>f<span class="tuareg-font-lock-operator">,</span> al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> deep_mkrangepat loc c1 c2 <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">if</span> c1 <span class="tuareg-font-lock-operator">=</span> c2 <span class="keyword">then</span> mkghpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_char c1<span class="tuareg-font-lock-operator">))</span>
    <span class="keyword">else</span>
      mkghpat loc
        <span class="tuareg-font-lock-operator">(</span>Ppat_or <span class="tuareg-font-lock-operator">(</span>mkghpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_char c1<span class="tuareg-font-lock-operator">)))</span>
          <span class="tuareg-font-lock-operator">(</span>deep_mkrangepat loc <span class="tuareg-font-lock-operator">(</span><span class="type">Char</span>.chr <span class="tuareg-font-lock-operator">(</span><span class="type">Char</span>.code c1 <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">))</span> c2<span class="tuareg-font-lock-operator">))</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> mkrangepat loc c1 c2 <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">if</span> c1 <span class="tuareg-font-lock-operator">&gt;</span> c2 <span class="keyword">then</span> mkrangepat loc c2 c1
    <span class="keyword">else</span> <span class="keyword">if</span> c1 <span class="tuareg-font-lock-operator">=</span> c2 <span class="keyword">then</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_char c1<span class="tuareg-font-lock-operator">))</span>
    <span class="keyword">else</span>
      mkpat loc
        <span class="tuareg-font-lock-operator">(</span>Ppat_or <span class="tuareg-font-lock-operator">(</span>mkghpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_char c1<span class="tuareg-font-lock-operator">)))</span>
          <span class="tuareg-font-lock-operator">(</span>deep_mkrangepat loc <span class="tuareg-font-lock-operator">(</span><span class="type">Char</span>.chr <span class="tuareg-font-lock-operator">(</span><span class="type">Char</span>.code c1 <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">))</span> c2<span class="tuareg-font-lock-operator">))</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> patt <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> mkpat loc </span><span class="tuareg-font-lock-operator">(</span><span class="type">Ppat_var s</span><span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">p </span><span class="tuareg-font-lock-operator">=</span> Ppat_construct <span class="tuareg-font-lock-operator">(</span>long_uident <span class="tuareg-font-lock-operator">~</span>conv_con i<span class="tuareg-font-lock-operator">)</span>
                  None <span class="tuareg-font-lock-operator">(</span>constructors_arity <span class="tuareg-font-lock-operator">())</span>
        <span class="tuareg-font-lock-governing">in</span> mkpat loc p
    <span class="tuareg-font-lock-operator">|</span> PaAli loc p1 p2 <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">p</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> i</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>p1<span class="tuareg-font-lock-operator">,</span> p2<span class="tuareg-font-lock-operator">)</span> <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span>p<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>p<span class="tuareg-font-lock-operator">,</span> s<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;,</span> p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>p<span class="tuareg-font-lock-operator">,</span> s<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"invalid alias pattern"</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_alias <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">)</span> i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> PaAnt loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"antiquotation not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> PaAny loc <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc Ppat_any
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">($</span>tup<span class="tuareg-font-lock-operator">:&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc_any<span class="tuareg-font-lock-operator">&lt;</span> _ <span class="tuareg-font-lock-operator">&gt;&gt;$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_construct <span class="tuareg-font-lock-operator">(</span>lident <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">))</span>
              <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>mkpat loc_any Ppat_any<span class="tuareg-font-lock-operator">))</span> False<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> PaApp loc _ _ <span class="keyword">as</span> f <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> al</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> patt_fa <span class="tuareg-font-lock-operator">[]</span> f <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">al </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map patt al <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>patt f<span class="tuareg-font-lock-operator">)</span>.ppat_desc <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> Ppat_construct li None _ <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="keyword">if</span> constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span>
              mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_construct li <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_tuple al<span class="tuareg-font-lock-operator">)))</span> True<span class="tuareg-font-lock-operator">)</span>
            <span class="keyword">else</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">a </span><span class="tuareg-font-lock-operator">=</span>
                <span class="keyword">match</span> al <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[</span>a<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> a
                <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_tuple al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
              <span class="tuareg-font-lock-governing">in</span>
              mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_construct li <span class="tuareg-font-lock-operator">(</span>Some a<span class="tuareg-font-lock-operator">)</span> False<span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">|</span> Ppat_variant s None <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">a </span><span class="tuareg-font-lock-operator">=</span>
              <span class="keyword">if</span> constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span>
                mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_tuple al<span class="tuareg-font-lock-operator">)</span>
              <span class="keyword">else</span>
                <span class="keyword">match</span> al <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[</span>a<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> a
                <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_tuple al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
            <span class="tuareg-font-lock-governing">in</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_variant s <span class="tuareg-font-lock-operator">(</span>Some a<span class="tuareg-font-lock-operator">))</span>
        <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span>
            error <span class="tuareg-font-lock-operator">(</span>loc_of_patt f<span class="tuareg-font-lock-operator">)</span>
              <span class="string">"this is not a constructor, it cannot be applied in a pattern"</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> PaArr loc p <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_array <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map patt <span class="tuareg-font-lock-operator">(</span>list_of_patt p <span class="tuareg-font-lock-operator">[])))</span>
    <span class="tuareg-font-lock-operator">|</span> PaChr loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_char <span class="tuareg-font-lock-operator">(</span>char_of_char_token loc s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> PaInt loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> int_of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_int i<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaInt32 loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i32 </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Int32</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int32"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_int32 i32<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaInt64 loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i64 </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Int64</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int64"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_int64 i64<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaNativeInt loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">nati </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Nativeint</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type nativeint"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_nativeint nati<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaFlo loc s <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_float <span class="tuareg-font-lock-operator">(</span>remove_underscores s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> PaLab loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labeled pattern not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> PaOlb loc _ _ <span class="tuareg-font-lock-operator">|</span> PaOlbi loc _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labeled pattern not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> PaOrp loc p1 p2 <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_or <span class="tuareg-font-lock-operator">(</span>patt p1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>patt p2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaRng loc p1 p2 <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>p1<span class="tuareg-font-lock-operator">,</span> p2<span class="tuareg-font-lock-operator">)</span> <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">(</span>PaChr loc1 c1<span class="tuareg-font-lock-operator">,</span> PaChr loc2 c2<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">c1 </span><span class="tuareg-font-lock-operator">=</span> char_of_char_token loc1 c1 <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">c2 </span><span class="tuareg-font-lock-operator">=</span> char_of_char_token loc2 c2 <span class="tuareg-font-lock-governing">in</span>
            mkrangepat loc c1 c2
        <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"range pattern allowed only for characters"</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> PaRec loc p <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ps </span><span class="tuareg-font-lock-operator">=</span> list_of_patt p <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">is_wildcard</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">fun</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> _ <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> True <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> False <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">wildcards</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">ps</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.partition is_wildcard ps <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">is_closed </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> wildcards <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">[]</span> <span class="keyword">then</span> Closed <span class="keyword">else</span> Open <span class="tuareg-font-lock-governing">in</span>
        mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_record <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map mklabpat ps<span class="tuareg-font-lock-operator">,</span> is_closed<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaStr loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constant <span class="tuareg-font-lock-operator">(</span>Const_string <span class="tuareg-font-lock-operator">(</span>string_of_string_token loc s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>p1<span class="tuareg-font-lock-operator">$,</span> <span class="tuareg-font-lock-operator">$</span>p2<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
         mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_tuple
           <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map patt <span class="tuareg-font-lock-operator">(</span>list_of_patt p1 <span class="tuareg-font-lock-operator">(</span>list_of_patt p2 <span class="tuareg-font-lock-operator">[]))))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>tup<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"singleton tuple pattern"</span>
    <span class="tuareg-font-lock-operator">|</span> PaTyc loc p t <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_constraint <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaTyp loc i <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_type <span class="tuareg-font-lock-operator">(</span>long_type_ident i<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaVrn loc s <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_variant s None<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> PaLaz loc p <span class="tuareg-font-lock-operator">-&gt;</span> mkpat loc <span class="tuareg-font-lock-operator">(</span>Ppat_lazy <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> PaEq _ _ _ <span class="tuareg-font-lock-operator">|</span> PaSem _ _ _ <span class="tuareg-font-lock-operator">|</span> PaCom _ _ _ <span class="tuareg-font-lock-operator">|</span> PaNil _ <span class="keyword">as</span> p <span class="tuareg-font-lock-operator">-&gt;</span>
        error <span class="tuareg-font-lock-operator">(</span>loc_of_patt p<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid pattern"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">mklabpat</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>p<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>ident <span class="tuareg-font-lock-operator">~</span><span class="variable-name">conv_lid</span><span class="tuareg-font-lock-operator">:</span><span class="type">conv_lab i</span><span class="tuareg-font-lock-operator">,</span> patt p<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> p <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_patt p<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid pattern"</span> <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> expr_fa al <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> ExApp _ f a <span class="tuareg-font-lock-operator">-&gt;</span> expr_fa <span class="tuareg-font-lock-operator">[</span>a <span class="tuareg-font-lock-operator">::</span> al<span class="tuareg-font-lock-operator">]</span> f
    <span class="tuareg-font-lock-operator">|</span> f <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>f<span class="tuareg-font-lock-operator">,</span> al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value <span class="tuareg-font-lock-governing">rec</span> class_expr_fa al <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> CeApp _ ce a <span class="tuareg-font-lock-operator">-&gt;</span> class_expr_fa <span class="tuareg-font-lock-operator">[</span>a <span class="tuareg-font-lock-operator">::</span> al<span class="tuareg-font-lock-operator">]</span> ce
    <span class="tuareg-font-lock-operator">|</span> ce <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>ce<span class="tuareg-font-lock-operator">,</span> al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>


  value <span class="tuareg-font-lock-governing">rec</span> sep_expr_acc l <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> ExAcc _ e1 e2 <span class="tuareg-font-lock-operator">-&gt;</span> sep_expr_acc <span class="tuareg-font-lock-operator">(</span>sep_expr_acc l e2<span class="tuareg-font-lock-operator">)</span> e1
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="keyword">as</span><span class="type"> e </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">match</span> l <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>loc<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">[],</span> e<span class="tuareg-font-lock-operator">)]</span>
        <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[(</span>loc<span class="tuareg-font-lock-operator">',</span> sl<span class="tuareg-font-lock-operator">,</span> e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span><span class="type">Loc</span>.merge loc loc<span class="tuareg-font-lock-operator">',</span> <span class="tuareg-font-lock-operator">[</span>s <span class="tuareg-font-lock-operator">::</span> sl<span class="tuareg-font-lock-operator">],</span> e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:(&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$.$</span>_<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="keyword">as</span> i<span class="tuareg-font-lock-operator">)$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">normalize_acc</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">fun</span>
         <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i1<span class="tuareg-font-lock-operator">$.$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>normalize_acc i1<span class="tuareg-font-lock-operator">$.$</span>normalize_acc i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>normalize_acc i1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>normalize_acc i2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">|</span>
            <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="keyword">as</span><span class="type"> i </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span> sep_expr_acc l <span class="tuareg-font-lock-operator">(</span>normalize_acc i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> e <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>loc_of_expr e<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">[],</span> e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value override_flag loc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">override_flag</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">!</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Override
        <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">override_flag</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Fresh
        <span class="tuareg-font-lock-operator">|</span>  _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"antiquotation not allowed here"</span>
        <span class="tuareg-font-lock-operator">];</span>

  value list_of_opt_ctyp ot acc <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> ot <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> list_of_ctyp t acc <span class="tuareg-font-lock-operator">];</span>

  value <span class="tuareg-font-lock-governing">rec</span> expr <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$.</span><span class="tuareg-font-lock-governing">val</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_apply <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>Lident <span class="string">"!"</span><span class="tuareg-font-lock-operator">)))</span> <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr x<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> ExAcc loc _ _ <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:&lt;:</span><span class="type">ident</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$</span> . <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="keyword">as</span> e <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">e</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> l</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> sep_expr_acc <span class="tuareg-font-lock-operator">[]</span> e <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[(</span>loc<span class="tuareg-font-lock-operator">,</span> ml<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ca </span><span class="tuareg-font-lock-operator">=</span> constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
              <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_construct <span class="tuareg-font-lock-operator">(</span>mkli <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span> ml<span class="tuareg-font-lock-operator">)</span> None ca<span class="tuareg-font-lock-operator">),</span> l<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[(</span>loc<span class="tuareg-font-lock-operator">,</span> ml<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>mkli s ml<span class="tuareg-font-lock-operator">)),</span> l<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[(</span>_<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">[],</span> e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">,</span> l<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"bad ast in expression"</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> e</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="type">List</span>.fold_left
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">loc_bp</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> e1</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">loc_ep</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ml</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> e2</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">match</span> e2 <span class="keyword">with</span>
              <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
                  <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">loc </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.merge loc_bp loc_ep
                  <span class="tuareg-font-lock-governing">in</span>  <span class="tuareg-font-lock-operator">(</span>loc<span class="tuareg-font-lock-operator">,</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_field e1 <span class="tuareg-font-lock-operator">(</span>mkli <span class="tuareg-font-lock-operator">(</span>conv_lab s<span class="tuareg-font-lock-operator">)</span> ml<span class="tuareg-font-lock-operator">)))</span>
              <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_expr e2<span class="tuareg-font-lock-operator">)</span> <span class="string">"lowercase identifier expected"</span> <span class="tuareg-font-lock-operator">])</span>
            <span class="tuareg-font-lock-operator">(</span>loc<span class="tuareg-font-lock-operator">,</span> e<span class="tuareg-font-lock-operator">)</span> l
        <span class="tuareg-font-lock-governing">in</span>
        e
    <span class="tuareg-font-lock-operator">|</span> ExAnt loc _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"antiquotation not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> ExApp loc _ _ <span class="keyword">as</span> f <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> al</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> expr_fa <span class="tuareg-font-lock-operator">[]</span> f <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">al </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map label_expr al <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>expr f<span class="tuareg-font-lock-operator">)</span>.pexp_desc <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> Pexp_construct li None _ <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">al </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map snd al <span class="tuareg-font-lock-governing">in</span>
            <span class="keyword">if</span> constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span>
              mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_construct li <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_tuple al<span class="tuareg-font-lock-operator">)))</span> True<span class="tuareg-font-lock-operator">)</span>
            <span class="keyword">else</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">a </span><span class="tuareg-font-lock-operator">=</span>
                <span class="keyword">match</span> al <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[</span>a<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> a
                <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_tuple al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
              <span class="tuareg-font-lock-governing">in</span>
              mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_construct li <span class="tuareg-font-lock-operator">(</span>Some a<span class="tuareg-font-lock-operator">)</span> False<span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">|</span> Pexp_variant s None <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">al </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map snd al <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">a </span><span class="tuareg-font-lock-operator">=</span>
              <span class="keyword">if</span> constructors_arity <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span>
                mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_tuple al<span class="tuareg-font-lock-operator">)</span>
              <span class="keyword">else</span>
                <span class="keyword">match</span> al <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[</span>a<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> a
                <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_tuple al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
            <span class="tuareg-font-lock-governing">in</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_variant s <span class="tuareg-font-lock-operator">(</span>Some a<span class="tuareg-font-lock-operator">))</span>
        <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_apply <span class="tuareg-font-lock-operator">(</span>expr f<span class="tuareg-font-lock-operator">)</span> al<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> ExAre loc e1 e2 <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_apply <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>array_function <span class="string">"Array"</span> <span class="string">"get"</span><span class="tuareg-font-lock-operator">)))</span>
            <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e1<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e2<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> ExArr loc e <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_array <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map expr <span class="tuareg-font-lock-operator">(</span>list_of_expr e <span class="tuareg-font-lock-operator">[])))</span>
    <span class="tuareg-font-lock-operator">|</span> ExAsf loc <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc Pexp_assertfalse
    <span class="tuareg-font-lock-operator">|</span> ExAss loc e v <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">e </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> e <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$.</span><span class="tuareg-font-lock-governing">val</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
              Pexp_apply <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>Lident <span class="string">":="</span><span class="tuareg-font-lock-operator">)))</span>
                <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr x<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr v<span class="tuareg-font-lock-operator">)]</span>
          <span class="tuareg-font-lock-operator">|</span> ExAcc loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">match</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span>.pexp_desc <span class="keyword">with</span>
              <span class="tuareg-font-lock-operator">[</span> Pexp_field e lab <span class="tuareg-font-lock-operator">-&gt;</span> Pexp_setfield e lab <span class="tuareg-font-lock-operator">(</span>expr v<span class="tuareg-font-lock-operator">)</span>
              <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"bad record access"</span> <span class="tuareg-font-lock-operator">]</span>
          <span class="tuareg-font-lock-operator">|</span> ExAre _ e1 e2 <span class="tuareg-font-lock-operator">-&gt;</span>
              Pexp_apply <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>array_function <span class="string">"Array"</span> <span class="string">"set"</span><span class="tuareg-font-lock-operator">)))</span>
                <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e1<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e2<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr v<span class="tuareg-font-lock-operator">)]</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">lab</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> Pexp_setinstvar lab </span><span class="tuareg-font-lock-operator">(</span><span class="type">expr v</span><span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> ExSte _ e1 e2 <span class="tuareg-font-lock-operator">-&gt;</span>
              Pexp_apply
                <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>array_function <span class="string">"String"</span> <span class="string">"set"</span><span class="tuareg-font-lock-operator">)))</span>
                <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e1<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e2<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr v<span class="tuareg-font-lock-operator">)]</span>
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"bad left part of assignment"</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        mkexp loc e
    <span class="tuareg-font-lock-operator">|</span> ExAsr loc e <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_assert <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExChr loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_char <span class="tuareg-font-lock-operator">(</span>char_of_char_token loc s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> ExCoe loc e t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t1 </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> t1 <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> None
          <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> Some <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constraint <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> t1 <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>ctyp t2<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> ExFlo loc s <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_float <span class="tuareg-font-lock-operator">(</span>remove_underscores s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> ExFor loc i e1 e2 df el <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">e3 </span><span class="tuareg-font-lock-operator">=</span> ExSeq loc el <span class="tuareg-font-lock-governing">in</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_for i <span class="tuareg-font-lock-operator">(</span>expr e1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e2<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>mkdirection df<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e3<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">fun</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">$</span>PaLab _ lab po<span class="tuareg-font-lock-operator">$</span> <span class="keyword">when</span> <span class="tuareg-font-lock-operator">$</span>w<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_function lab None
            <span class="tuareg-font-lock-operator">[(</span>patt_of_lab loc lab po<span class="tuareg-font-lock-operator">,</span> when_expr e w<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">fun</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">$</span>PaOlbi _ lab p e1<span class="tuareg-font-lock-operator">$</span> <span class="keyword">when</span> <span class="tuareg-font-lock-operator">$</span>w<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">$</span>e2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">lab </span><span class="tuareg-font-lock-operator">=</span> paolab lab p <span class="tuareg-font-lock-governing">in</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_function <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>expr e1<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">[(</span>patt p<span class="tuareg-font-lock-operator">,</span> when_expr e2 w<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">fun</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">$</span>PaOlb _ lab p<span class="tuareg-font-lock-operator">$</span> <span class="keyword">when</span> <span class="tuareg-font-lock-operator">$</span>w<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">lab </span><span class="tuareg-font-lock-operator">=</span> paolab lab p <span class="tuareg-font-lock-governing">in</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_function <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> None <span class="tuareg-font-lock-operator">[(</span>patt_of_lab loc lab p<span class="tuareg-font-lock-operator">,</span> when_expr e w<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> ExFun loc a <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_function <span class="string">""</span> None <span class="tuareg-font-lock-operator">(</span>match_case a <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> ExIfe loc e1 e2 e3 <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ifthenelse <span class="tuareg-font-lock-operator">(</span>expr e1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e2<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>expr e3<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> ExInt loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> int_of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_int i<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExInt32 loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i32 </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Int32</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int32"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_int32 i32<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExInt64 loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">i64 </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Int64</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type int64"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_int64 i64<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExNativeInt loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">nati </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">try</span> <span class="type">Nativeint</span>.of_string s <span class="keyword">with</span> <span class="tuareg-font-lock-operator">[</span>
          Failure _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"Integer literal exceeds the range of representable integers of type nativeint"</span>
        <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_nativeint nati<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExLab loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labeled expression not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> ExLaz loc e <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_lazy <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExLet loc rf bi e <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_let <span class="tuareg-font-lock-operator">(</span>mkrf rf<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>binding bi <span class="tuareg-font-lock-operator">[])</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExLmd loc i me e <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_letmodule i <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExMat loc e a <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_match <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>match_case a <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> ExNew loc id <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_new <span class="tuareg-font-lock-operator">(</span>long_type_ident id<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExObj loc po cfl <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">p </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> po <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> _ <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> p <span class="tuareg-font-lock-operator">-&gt;</span> p <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cil </span><span class="tuareg-font-lock-operator">=</span> class_str_item cfl <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_object <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">,</span> cil<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> ExOlb loc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"labeled expression not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> ExOvr loc iel <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_override <span class="tuareg-font-lock-operator">(</span>mkideexp iel <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> ExRec loc lel eo <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">match</span> lel <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"empty record"</span>
        <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">eo </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">match</span> eo <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> None
            <span class="tuareg-font-lock-operator">|</span> e <span class="tuareg-font-lock-operator">-&gt;</span> Some <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span>
          mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_record <span class="tuareg-font-lock-operator">(</span>mklabexp lel <span class="tuareg-font-lock-operator">[])</span> eo<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> ExSeq _loc e <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">loop</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">fun</span>
         <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> expr <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[</span>e<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span> expr e
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[</span>e <span class="tuareg-font-lock-operator">::</span> el<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_loc </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.merge <span class="tuareg-font-lock-operator">(</span>loc_of_expr e<span class="tuareg-font-lock-operator">)</span> _loc <span class="tuareg-font-lock-governing">in</span>
              mkexp _loc <span class="tuareg-font-lock-operator">(</span>Pexp_sequence <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>loop el<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        loop <span class="tuareg-font-lock-operator">(</span>list_of_expr e <span class="tuareg-font-lock-operator">[])</span>
    <span class="tuareg-font-lock-operator">|</span> ExSnd loc e s <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_send <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> s<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> ExSte loc e1 e2 <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc
          <span class="tuareg-font-lock-operator">(</span>Pexp_apply <span class="tuareg-font-lock-operator">(</span>mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>array_function <span class="string">"String"</span> <span class="string">"get"</span><span class="tuareg-font-lock-operator">)))</span>
            <span class="tuareg-font-lock-operator">[(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e1<span class="tuareg-font-lock-operator">);</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e2<span class="tuareg-font-lock-operator">)])</span>
    <span class="tuareg-font-lock-operator">|</span> ExStr loc s <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constant <span class="tuareg-font-lock-operator">(</span>Const_string <span class="tuareg-font-lock-operator">(</span>string_of_string_token loc s<span class="tuareg-font-lock-operator">)))</span>
    <span class="tuareg-font-lock-operator">|</span> ExTry loc e a <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_try <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>match_case a <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>e1<span class="tuareg-font-lock-operator">$,</span> <span class="tuareg-font-lock-operator">$</span>e2<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
         mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_tuple <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map expr <span class="tuareg-font-lock-operator">(</span>list_of_expr e1 <span class="tuareg-font-lock-operator">(</span>list_of_expr e2 <span class="tuareg-font-lock-operator">[]))))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>tup<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"singleton tuple"</span>
    <span class="tuareg-font-lock-operator">|</span> ExTyc loc e t <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_constraint <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">))</span> None<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_construct <span class="tuareg-font-lock-operator">(</span>lident <span class="string">"()"</span><span class="tuareg-font-lock-operator">)</span> None True<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_ident <span class="tuareg-font-lock-operator">(</span>lident s<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="comment">(* let ca = constructors_arity () in *)</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_construct <span class="tuareg-font-lock-operator">(</span>lident <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">))</span> None True<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> ExVrn loc s <span class="tuareg-font-lock-operator">-&gt;</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_variant s None<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> ExWhi loc e1 el <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">e2 </span><span class="tuareg-font-lock-operator">=</span> ExSeq loc el <span class="tuareg-font-lock-governing">in</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_while <span class="tuareg-font-lock-operator">(</span>expr e1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">open</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">$</span><span class="variable-name">i</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-governing">in</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">$</span><span class="variable-name">e</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_open <span class="tuareg-font-lock-operator">(</span>long_uident i<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">module</span> <span class="tuareg-font-lock-operator">$</span><span class="type">me</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">pt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_pack <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>package_type pt<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">module</span> <span class="tuareg-font-lock-operator">$</span><span class="type">_</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"(module_expr : package_type) expected here"</span>
    <span class="tuareg-font-lock-operator">|</span> ExFUN loc i e <span class="tuareg-font-lock-operator">-&gt;</span>
        mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_newtype i <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$,$</span>_<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"expr, expr: not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$;$</span>_<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"expr; expr: not allowed here, use do {...} or [|...|] to surround them"</span>
    <span class="tuareg-font-lock-operator">|</span> ExId _ _ <span class="tuareg-font-lock-operator">|</span> ExNil _ <span class="keyword">as</span> e <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_expr e<span class="tuareg-font-lock-operator">)</span> <span class="string">"invalid expr"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">patt_of_lab</span><span class="variable-name"> _loc lab </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> patt <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">lab</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span>
    <span class="tuareg-font-lock-operator">|</span> p <span class="tuareg-font-lock-operator">-&gt;</span> patt p <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">expr_of_lab</span><span class="variable-name"> _loc lab </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> expr <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">lab</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span>
    <span class="tuareg-font-lock-operator">|</span> e <span class="tuareg-font-lock-operator">-&gt;</span> expr e <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">label_expr</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> ExLab loc lab eo <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>lab<span class="tuareg-font-lock-operator">,</span> expr_of_lab loc lab eo<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> ExOlb loc lab eo <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">,</span> expr_of_lab loc lab eo<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> e <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span><span class="string">""</span><span class="tuareg-font-lock-operator">,</span> expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">binding</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">y</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
         binding x <span class="tuareg-font-lock-operator">(</span>binding y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">binding</span><span class="tuareg-font-lock-operator">@</span>_loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>p<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">($</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">!</span> <span class="tuareg-font-lock-operator">$</span>vs<span class="tuareg-font-lock-operator">$</span> . <span class="tuareg-font-lock-operator">$</span>ty<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>patt <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>p<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">!</span> <span class="tuareg-font-lock-operator">$</span>vs<span class="tuareg-font-lock-operator">$</span> . <span class="tuareg-font-lock-operator">$</span>ty<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&gt;&gt;,</span> expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>p<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>patt p<span class="tuareg-font-lock-operator">,</span> expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">binding</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">match_case</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">match_case</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">$</span>y<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> match_case x <span class="tuareg-font-lock-operator">(</span>match_case y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">match_case</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>pat<span class="tuareg-font-lock-operator">:</span><span class="type">p</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="keyword">when</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">w</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">e</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>patt p<span class="tuareg-font-lock-operator">,</span> when_expr e w<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">match_case</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">when_expr</span><span class="variable-name"> e w </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> w <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> expr e
    <span class="tuareg-font-lock-operator">|</span> w <span class="tuareg-font-lock-operator">-&gt;</span> mkexp <span class="tuareg-font-lock-operator">(</span>loc_of_expr w<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>Pexp_when <span class="tuareg-font-lock-operator">(</span>expr w<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">mklabexp</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>y<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
         mklabexp x <span class="tuareg-font-lock-operator">(</span>mklabexp y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>ident <span class="tuareg-font-lock-operator">~</span><span class="variable-name">conv_lid</span><span class="tuareg-font-lock-operator">:</span><span class="type">conv_lab i</span><span class="tuareg-font-lock-operator">,</span> expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">mkideexp</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> acc
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>y<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
         mkideexp x <span class="tuareg-font-lock-operator">(</span>mkideexp y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">rec_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>lid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">mktype_decl</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">y</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
         mktype_decl x <span class="tuareg-font-lock-operator">(</span>mktype_decl y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="type">Ast</span>.TyDcl _ c tl td cl <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cl </span><span class="tuareg-font-lock-operator">=</span>
          <span class="type">List</span>.map
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">t1</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> t2</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">loc </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Loc</span>.merge <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t2<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
              <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">,</span> ctyp t2<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">))</span>
            cl
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-operator">[(</span>c<span class="tuareg-font-lock-operator">,</span> type_decl <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.fold_right type_parameters tl <span class="tuareg-font-lock-operator">[])</span> cl td<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">module_type</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"abstract/nil module type not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> mkmty loc </span><span class="tuareg-font-lock-operator">(</span>Pmty_ident <span class="tuareg-font-lock-operator">(</span>long_uident i<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">functor</span> <span class="tuareg-font-lock-operator">($</span>n<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">nt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">$</span>mt<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmty loc <span class="tuareg-font-lock-operator">(</span>Pmty_functor n <span class="tuareg-font-lock-operator">(</span>module_type nt<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">'$</span>_<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"module type variable not allowed here"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">sig</span> <span class="tuareg-font-lock-operator">$</span>sl<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">end</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmty loc <span class="tuareg-font-lock-operator">(</span>Pmty_signature <span class="tuareg-font-lock-operator">(</span>sig_item sl <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>mt<span class="tuareg-font-lock-operator">$</span> <span class="keyword">with</span> <span class="tuareg-font-lock-operator">$</span>wc<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmty loc <span class="tuareg-font-lock-operator">(</span>Pmty_with <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>mkwithc wc <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_type</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="keyword">assert</span><span class="type"> False </span><span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">sig_item</span><span class="variable-name"> s l </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> s <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">sig_item</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> SgCls loc cd <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_class
           <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map class_info_class_type <span class="tuareg-font-lock-operator">(</span>list_of_class_type cd <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgClt loc ctd <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_class_type
           <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map class_info_class_type <span class="tuareg-font-lock-operator">(</span>list_of_class_type ctd <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">sig_item</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>sg1<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>sg2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> sig_item sg1 <span class="tuareg-font-lock-operator">(</span>sig_item sg2 l<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> SgDir _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">sig_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">exception</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_exception <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">[])</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">sig_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">exception</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">of</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">t</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_exception <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span>
                                   <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgExc _ _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="comment">(*FIXME*)</span>
    <span class="tuareg-font-lock-operator">|</span> SgExt loc n t sl <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_value n <span class="tuareg-font-lock-operator">(</span>mkvalue_desc t <span class="tuareg-font-lock-operator">(</span>list_of_meta_list sl<span class="tuareg-font-lock-operator">)))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgInc loc mt <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_include <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgMod loc n mt <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_module n <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgRecMod loc mb <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_recmodule <span class="tuareg-font-lock-operator">(</span>module_sig_binding mb <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgMty loc n mt <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">si </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> mt <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> MtQuo _ _ <span class="tuareg-font-lock-operator">-&gt;</span> Pmodtype_abstract
          <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> Pmodtype_manifest <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_modtype n si<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgOpn loc id <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_open <span class="tuareg-font-lock-operator">(</span>long_uident id<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgTyp loc tdl <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_type <span class="tuareg-font-lock-operator">(</span>mktype_decl tdl <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> SgVal loc n t <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mksig loc <span class="tuareg-font-lock-operator">(</span>Psig_value n <span class="tuareg-font-lock-operator">(</span>mkvalue_desc t <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">sig_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> error loc </span><span class="string">"antiquotation in sig_item"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">module_sig_binding</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">y</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        module_sig_binding x <span class="tuareg-font-lock-operator">(</span>module_sig_binding y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">mt</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> module_type mt<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">module_str_binding</span><span class="variable-name"> x acc </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> x <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>x<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-operator">$</span><span class="variable-name">y</span><span class="tuareg-font-lock-operator">$</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        module_str_binding x <span class="tuareg-font-lock-operator">(</span>module_str_binding y acc<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_binding</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>s<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">mt</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>me<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[(</span>s<span class="tuareg-font-lock-operator">,</span> module_type mt<span class="tuareg-font-lock-operator">,</span> module_expr me<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> acc<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">module_expr</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> error loc <span class="string">"nil module expression"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>id<span class="tuareg-font-lock-operator">:</span><span class="type">i</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> mkmod loc </span><span class="tuareg-font-lock-operator">(</span>Pmod_ident <span class="tuareg-font-lock-operator">(</span>long_uident i<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>me1<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">$</span>me2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmod loc <span class="tuareg-font-lock-operator">(</span>Pmod_apply <span class="tuareg-font-lock-operator">(</span>module_expr me1<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>module_expr me2<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">functor</span> <span class="tuareg-font-lock-operator">($</span>n<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">mt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">$</span>me<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmod loc <span class="tuareg-font-lock-operator">(</span>Pmod_functor n <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-governing">struct</span> <span class="tuareg-font-lock-operator">$</span>sl<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-governing">end</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmod loc <span class="tuareg-font-lock-operator">(</span>Pmod_structure <span class="tuareg-font-lock-operator">(</span>str_item sl <span class="tuareg-font-lock-operator">[]))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">($</span>me<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">mt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmod loc <span class="tuareg-font-lock-operator">(</span>Pmod_constraint <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">(</span>value <span class="tuareg-font-lock-operator">$</span>e<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">$</span><span class="type">pt</span><span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        mkmod loc <span class="tuareg-font-lock-operator">(</span>Pmod_unpack <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>package_type pt<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">(</span>value <span class="tuareg-font-lock-operator">$</span>_<span class="tuareg-font-lock-operator">$)</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"(value expr) not supported yet"</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">module_expr</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> error loc </span><span class="string">"antiquotation in module_expr"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">str_item</span><span class="variable-name"> s l </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> s <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> StCls loc cd <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_class
           <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map class_info_class_expr <span class="tuareg-font-lock-operator">(</span>list_of_class_expr cd <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StClt loc ctd <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_class_type
           <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map class_info_class_type <span class="tuareg-font-lock-operator">(</span>list_of_class_type ctd <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>st1<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>st2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> str_item st1 <span class="tuareg-font-lock-operator">(</span>str_item st2 l<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> StDir _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">exception</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_exception <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">[])</span> <span class="tuareg-font-lock-operator">::</span> l <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">exception</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">of</span><span class="type"> </span><span class="tuareg-font-lock-operator">$</span><span class="type">t</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_exception <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span>
                      <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_ctyp t <span class="tuareg-font-lock-operator">[])))</span> <span class="tuareg-font-lock-operator">::</span> l <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="keyword">exception</span> <span class="tuareg-font-lock-operator">$</span>uid<span class="tuareg-font-lock-operator">:</span><span class="type">s</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">$</span>i<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_exn_rebind <span class="tuareg-font-lock-operator">(</span>conv_con s<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ident i<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l <span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StExc _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="comment">(*FIXME*)</span>
    <span class="tuareg-font-lock-operator">|</span> StExp loc e <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_eval <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StExt loc n t sl <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_primitive n <span class="tuareg-font-lock-operator">(</span>mkvalue_desc t <span class="tuareg-font-lock-operator">(</span>list_of_meta_list sl<span class="tuareg-font-lock-operator">)))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StInc loc me <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_include <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StMod loc n me <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_module n <span class="tuareg-font-lock-operator">(</span>module_expr me<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StRecMod loc mb <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_recmodule <span class="tuareg-font-lock-operator">(</span>module_str_binding mb <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StMty loc n mt <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_modtype n <span class="tuareg-font-lock-operator">(</span>module_type mt<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StOpn loc id <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_open <span class="tuareg-font-lock-operator">(</span>long_uident id<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StTyp loc tdl <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_type <span class="tuareg-font-lock-operator">(</span>mktype_decl tdl <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> StVal loc rf bi <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>mkstr loc <span class="tuareg-font-lock-operator">(</span>Pstr_value <span class="tuareg-font-lock-operator">(</span>mkrf rf<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>binding bi <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">str_item</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>anti<span class="tuareg-font-lock-operator">:</span><span class="type">_</span><span class="tuareg-font-lock-operator">$</span><span class="type"> </span><span class="tuareg-font-lock-operator">&gt;&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> error loc </span><span class="string">"antiquotation in str_item"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_type</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> CtCon loc ViNil id tl <span class="tuareg-font-lock-operator">-&gt;</span>
        mkcty loc
          <span class="tuareg-font-lock-operator">(</span>Pcty_constr <span class="tuareg-font-lock-operator">(</span>long_class_ident id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_opt_ctyp tl <span class="tuareg-font-lock-operator">[])))</span>
    <span class="tuareg-font-lock-operator">|</span> CtFun loc <span class="tuareg-font-lock-operator">(</span>TyLab _ lab t<span class="tuareg-font-lock-operator">)</span> ct <span class="tuareg-font-lock-operator">-&gt;</span>
        mkcty loc <span class="tuareg-font-lock-operator">(</span>Pcty_fun lab <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_type ct<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CtFun loc <span class="tuareg-font-lock-operator">(</span>TyOlb loc1 lab t<span class="tuareg-font-lock-operator">)</span> ct <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span> TyApp loc1 <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc1<span class="tuareg-font-lock-operator">&lt;</span> option <span class="tuareg-font-lock-operator">&gt;&gt;</span> t <span class="tuareg-font-lock-governing">in</span>
        mkcty loc <span class="tuareg-font-lock-operator">(</span>Pcty_fun <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_type ct<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CtFun loc t ct <span class="tuareg-font-lock-operator">-&gt;</span> mkcty loc <span class="tuareg-font-lock-operator">(</span>Pcty_fun <span class="string">""</span> <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_type ct<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CtSig loc t_o ctfl <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> t_o <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> _ <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> t <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cil </span><span class="tuareg-font-lock-operator">=</span> class_sig_item ctfl <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
        mkcty loc <span class="tuareg-font-lock-operator">(</span>Pcty_signature <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">,</span> cil<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CtCon loc _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"invalid virtual class inside a class type"</span>
    <span class="tuareg-font-lock-operator">|</span> CtAnt _ _ <span class="tuareg-font-lock-operator">|</span> CtEq _ _ _ <span class="tuareg-font-lock-operator">|</span> CtCol _ _ _ <span class="tuareg-font-lock-operator">|</span> CtAnd _ _ _ <span class="tuareg-font-lock-operator">|</span> CtNil _ <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>

  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_info_class_expr</span><span class="variable-name"> ci </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> ci <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> CeEq _ <span class="tuareg-font-lock-operator">(</span>CeCon loc vir <span class="tuareg-font-lock-operator">(</span>IdLid _ name<span class="tuareg-font-lock-operator">)</span> params<span class="tuareg-font-lock-operator">)</span> ce <span class="tuareg-font-lock-operator">-&gt;</span>
      <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span>loc_params<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>params<span class="tuareg-font-lock-operator">,</span> variance<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">match</span> params <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>loc<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">([],</span> <span class="tuareg-font-lock-operator">[]))</span>
        <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t<span class="tuareg-font-lock-operator">,</span> <span class="type">List</span>.split <span class="tuareg-font-lock-operator">(</span>class_parameters t <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">]</span>
      <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-operator">{</span>pci_virt <span class="tuareg-font-lock-operator">=</span> mkvirtual vir<span class="tuareg-font-lock-operator">;</span>
       pci_params <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>params<span class="tuareg-font-lock-operator">,</span> mkloc loc_params<span class="tuareg-font-lock-operator">);</span>
       pci_name <span class="tuareg-font-lock-operator">=</span> name<span class="tuareg-font-lock-operator">;</span>
       pci_expr <span class="tuareg-font-lock-operator">=</span> class_expr ce<span class="tuareg-font-lock-operator">;</span>
       pci_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">;</span>
       pci_variance <span class="tuareg-font-lock-operator">=</span> variance<span class="tuareg-font-lock-operator">}</span>
    <span class="tuareg-font-lock-operator">|</span> ce <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_class_expr ce<span class="tuareg-font-lock-operator">)</span> <span class="string">"bad class definition"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_info_class_type</span><span class="variable-name"> ci </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> ci <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> CtEq _ <span class="tuareg-font-lock-operator">(</span>CtCon loc vir <span class="tuareg-font-lock-operator">(</span>IdLid _ name<span class="tuareg-font-lock-operator">)</span> params<span class="tuareg-font-lock-operator">)</span> ct <span class="tuareg-font-lock-operator">|</span>
      CtCol _ <span class="tuareg-font-lock-operator">(</span>CtCon loc vir <span class="tuareg-font-lock-operator">(</span>IdLid _ name<span class="tuareg-font-lock-operator">)</span> params<span class="tuareg-font-lock-operator">)</span> ct <span class="tuareg-font-lock-operator">-&gt;</span>
      <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span>loc_params<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>params<span class="tuareg-font-lock-operator">,</span> variance<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">match</span> params <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>loc<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">([],</span> <span class="tuareg-font-lock-operator">[]))</span>
        <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>loc_of_ctyp t<span class="tuareg-font-lock-operator">,</span> <span class="type">List</span>.split <span class="tuareg-font-lock-operator">(</span>class_parameters t <span class="tuareg-font-lock-operator">[]))</span> <span class="tuareg-font-lock-operator">]</span>
      <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-operator">{</span>pci_virt <span class="tuareg-font-lock-operator">=</span> mkvirtual vir<span class="tuareg-font-lock-operator">;</span>
       pci_params <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>params<span class="tuareg-font-lock-operator">,</span> mkloc loc_params<span class="tuareg-font-lock-operator">);</span>
       pci_name <span class="tuareg-font-lock-operator">=</span> name<span class="tuareg-font-lock-operator">;</span>
       pci_expr <span class="tuareg-font-lock-operator">=</span> class_type ct<span class="tuareg-font-lock-operator">;</span>
       pci_loc <span class="tuareg-font-lock-operator">=</span> mkloc loc<span class="tuareg-font-lock-operator">;</span>
       pci_variance <span class="tuareg-font-lock-operator">=</span> variance<span class="tuareg-font-lock-operator">}</span>
    <span class="tuareg-font-lock-operator">|</span> ct <span class="tuareg-font-lock-operator">-&gt;</span> error <span class="tuareg-font-lock-operator">(</span>loc_of_class_type ct<span class="tuareg-font-lock-operator">)</span>
              <span class="string">"bad class/class type declaration/definition"</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_sig_item</span><span class="variable-name"> c l </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> c <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">class_sig_item</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> CgCtr loc t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Pctf_cstr <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">,</span> ctyp t2<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">class_sig_item</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>csg1<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>csg2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        class_sig_item csg1 <span class="tuareg-font-lock-operator">(</span>class_sig_item csg2 l<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> CgInh _ ct <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Pctf_inher <span class="tuareg-font-lock-operator">(</span>class_type ct<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CgMth loc s pf t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pctf_meth <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkprivate pf<span class="tuareg-font-lock-operator">,</span> mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CgVal loc s b v t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pctf_val <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkmutable b<span class="tuareg-font-lock-operator">,</span> mkvirtual v<span class="tuareg-font-lock-operator">,</span> ctyp t<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CgVir loc s b t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pctf_virt <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkprivate b<span class="tuareg-font-lock-operator">,</span> mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CgAnt _ _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_expr</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> CeApp loc _ _ <span class="keyword">as</span> c <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">ce</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> el</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> class_expr_fa <span class="tuareg-font-lock-operator">[]</span> c <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">el </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map label_expr el <span class="tuareg-font-lock-governing">in</span>
        mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_apply <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">)</span> el<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> CeCon loc ViNil id tl <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpcl loc
          <span class="tuareg-font-lock-operator">(</span>Pcl_constr <span class="tuareg-font-lock-operator">(</span>long_class_ident id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map ctyp <span class="tuareg-font-lock-operator">(</span>list_of_opt_ctyp tl <span class="tuareg-font-lock-operator">[])))</span>
    <span class="tuareg-font-lock-operator">|</span> CeFun loc <span class="tuareg-font-lock-operator">(</span>PaLab _ lab po<span class="tuareg-font-lock-operator">)</span> ce <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpcl loc
          <span class="tuareg-font-lock-operator">(</span>Pcl_fun lab None <span class="tuareg-font-lock-operator">(</span>patt_of_lab loc lab po<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeFun loc <span class="tuareg-font-lock-operator">(</span>PaOlbi _ lab p e<span class="tuareg-font-lock-operator">)</span> ce <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">lab </span><span class="tuareg-font-lock-operator">=</span> paolab lab p <span class="tuareg-font-lock-governing">in</span>
        mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_fun <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>Some <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeFun loc <span class="tuareg-font-lock-operator">(</span>PaOlb _ lab p<span class="tuareg-font-lock-operator">)</span> ce <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">lab </span><span class="tuareg-font-lock-operator">=</span> paolab lab p <span class="tuareg-font-lock-governing">in</span>
        mkpcl loc
          <span class="tuareg-font-lock-operator">(</span>Pcl_fun <span class="tuareg-font-lock-operator">(</span><span class="string">"?"</span> <span class="tuareg-font-lock-operator">^</span> lab<span class="tuareg-font-lock-operator">)</span> None <span class="tuareg-font-lock-operator">(</span>patt_of_lab loc lab p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeFun loc p ce <span class="tuareg-font-lock-operator">-&gt;</span> mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_fun <span class="string">""</span> None <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeLet loc rf bi ce <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_let <span class="tuareg-font-lock-operator">(</span>mkrf rf<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>binding bi <span class="tuareg-font-lock-operator">[])</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeStr loc po cfl <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">p </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> po <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">patt</span><span class="tuareg-font-lock-operator">@</span>loc<span class="tuareg-font-lock-operator">&lt;</span> _ <span class="tuareg-font-lock-operator">&gt;&gt;</span>
          <span class="tuareg-font-lock-operator">|</span> p <span class="tuareg-font-lock-operator">-&gt;</span> p <span class="tuareg-font-lock-operator">]</span>
        <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cil </span><span class="tuareg-font-lock-operator">=</span> class_str_item cfl <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
        mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_structure <span class="tuareg-font-lock-operator">(</span>patt p<span class="tuareg-font-lock-operator">,</span> cil<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeTyc loc ce ct <span class="tuareg-font-lock-operator">-&gt;</span>
        mkpcl loc <span class="tuareg-font-lock-operator">(</span>Pcl_constraint <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_type ct<span class="tuareg-font-lock-operator">))</span>
    <span class="tuareg-font-lock-operator">|</span> CeCon loc _ _ _ <span class="tuareg-font-lock-operator">-&gt;</span>
        error loc <span class="string">"invalid virtual class inside a class expression"</span>
    <span class="tuareg-font-lock-operator">|</span> CeAnt _ _ <span class="tuareg-font-lock-operator">|</span> CeEq _ _ _ <span class="tuareg-font-lock-operator">|</span> CeAnd _ _ _ <span class="tuareg-font-lock-operator">|</span> CeNil _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-governing">and</span> <span class="function-name">class_str_item</span><span class="variable-name"> c l </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> c <span class="keyword">with</span>
    <span class="tuareg-font-lock-operator">[</span> CrNil _ <span class="tuareg-font-lock-operator">-&gt;</span> l
    <span class="tuareg-font-lock-operator">|</span> CrCtr loc t1 t2 <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Pcf_cstr <span class="tuareg-font-lock-operator">(</span>ctyp t1<span class="tuareg-font-lock-operator">,</span> ctyp t2<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">class_str_item</span><span class="tuareg-font-lock-operator">&lt;</span> <span class="tuareg-font-lock-operator">$</span>cst1<span class="tuareg-font-lock-operator">$;</span> <span class="tuareg-font-lock-operator">$</span>cst2<span class="tuareg-font-lock-operator">$</span> <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span>
        class_str_item cst1 <span class="tuareg-font-lock-operator">(</span>class_str_item cst2 l<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> CrInh loc ov ce pb <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">opb </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> pb <span class="tuareg-font-lock-operator">=</span> <span class="string">""</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some pb <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-operator">[</span>Pcf_inher <span class="tuareg-font-lock-operator">(</span>override_flag loc ov<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>class_expr ce<span class="tuareg-font-lock-operator">)</span> opb <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrIni _ e <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[</span>Pcf_init <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrMth loc s ov pf e t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> t <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">ctyp</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> None
          <span class="tuareg-font-lock-operator">|</span> t <span class="tuareg-font-lock-operator">-&gt;</span> Some <span class="tuareg-font-lock-operator">(</span>mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">e </span><span class="tuareg-font-lock-operator">=</span> mkexp loc <span class="tuareg-font-lock-operator">(</span>Pexp_poly <span class="tuareg-font-lock-operator">(</span>expr e<span class="tuareg-font-lock-operator">)</span> t<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-operator">[</span>Pcf_meth <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkprivate pf<span class="tuareg-font-lock-operator">,</span> override_flag loc ov<span class="tuareg-font-lock-operator">,</span> e<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrVal loc s ov mf e <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pcf_val <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkmutable mf<span class="tuareg-font-lock-operator">,</span> override_flag loc ov<span class="tuareg-font-lock-operator">,</span> expr e<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrVir loc s pf t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pcf_virt <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkprivate pf<span class="tuareg-font-lock-operator">,</span> mkpolytype <span class="tuareg-font-lock-operator">(</span>ctyp t<span class="tuareg-font-lock-operator">),</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrVvr loc s mf t <span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="tuareg-font-lock-operator">[</span>Pcf_valvirt <span class="tuareg-font-lock-operator">(</span>s<span class="tuareg-font-lock-operator">,</span> mkmutable mf<span class="tuareg-font-lock-operator">,</span> ctyp t<span class="tuareg-font-lock-operator">,</span> mkloc loc<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">::</span> l<span class="tuareg-font-lock-operator">]</span>
    <span class="tuareg-font-lock-operator">|</span> CrAnt _ _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> False <span class="tuareg-font-lock-operator">];</span>

  value sig_item ast <span class="tuareg-font-lock-operator">=</span> sig_item ast <span class="tuareg-font-lock-operator">[];</span>
  value str_item ast <span class="tuareg-font-lock-operator">=</span> str_item ast <span class="tuareg-font-lock-operator">[];</span>

  value directive <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_none
    <span class="tuareg-font-lock-operator">|</span> ExStr _ s <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_string s
    <span class="tuareg-font-lock-operator">|</span> ExInt _ i <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_int <span class="tuareg-font-lock-operator">(</span>int_of_string i<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> True <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_bool True
    <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">&lt;:</span><span class="type">expr</span><span class="tuareg-font-lock-operator">&lt;</span> False <span class="tuareg-font-lock-operator">&gt;&gt;</span> <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_bool False
    <span class="tuareg-font-lock-operator">|</span> e <span class="tuareg-font-lock-operator">-&gt;</span> Pdir_ident <span class="tuareg-font-lock-operator">(</span>ident <span class="tuareg-font-lock-operator">(</span>ident_of_expr e<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>

  value phrase <span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">fun</span>
   <span class="variable-name"> </span><span class="tuareg-font-lock-operator">[</span> StDir _ d dp <span class="tuareg-font-lock-operator">-&gt;</span> Ptop_dir d <span class="tuareg-font-lock-operator">(</span>directive dp<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">|</span> si <span class="tuareg-font-lock-operator">-&gt;</span> Ptop_def <span class="tuareg-font-lock-operator">(</span>str_item si<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">]</span>
  <span class="tuareg-font-lock-operator">;</span>
<span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">;</span>
</pre>
  </body>
</html>
